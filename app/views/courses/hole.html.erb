<div class="app-container max-w-[1600px] mx-auto min-h-[calc(100dvh-57px)] overflow-hidden relative">


  <div class="main-content flex flex-col md:flex-row pt-0 h-full overflow-y-auto md:overflow-visible snap-y md:snap-none snap-mandatory scroll-smooth pb-20 md:pb-0">
    <div class="course-container w-full md:flex-1 relative flex items-center justify-center p-0 min-h-[300px] md:min-h-[400px] md:h-auto snap-start min-h-[calc(100dvh-4rem-57px)] md:min-h-0">
      <% has_stylized = @display_image&.stylized? %>
      <% if @hole.stylization_status == 'processing' && !has_stylized %>
        <div class="absolute top-4 left-4 text-caption bg-black/60 border border-white/10 px-3 py-1 rounded">
          Stylizing imageâ€¦ this can take up to a minute. This page will auto-refresh.
          <meta http-equiv="refresh" content="10">
        </div>
      <% elsif @hole.stylization_status == 'failed' && @hole.stylization_error.present? %>
        <div class="absolute top-4 left-4 text-red-400 bg-black/60 border border-white/10 px-3 py-1 rounded">
          Stylization failed: <%= @hole.stylization_error %>
        </div>
      <% end %>

      <% if @display_image&.image&.attached? %>
        <% # Limit to 6 images to reduce URL generation time %>
        <% images = @hole.images_for_display.limit(6).to_a %>
        <% initial_index = [images.index(@display_image) || 0, 0].max %>
        <div class="relative w-full h-full flex items-center justify-center"
             data-controller="image-swiper"
             data-image-swiper-target="container"
             data-image-swiper-images-value='<%= raw(images.map { |i| url_for(i.image) }.to_json) %>'
             data-image-swiper-index-value="<%= initial_index %>"
             data-action="touchstart->image-swiper#touchStart touchmove->image-swiper#touchMove touchend->image-swiper#touchEnd">
          
          <!-- Loading skeleton -->
          <div data-image-swiper-target="loader" class="absolute inset-0 flex items-center justify-center bg-gradient-to-br from-gray-900 via-gray-800 to-gray-900 rounded-xl">
            <div class="flex flex-col items-center gap-3">
              <div class="w-12 h-12 border-4 border-white/20 border-t-[#00dc82] rounded-full animate-spin"></div>
              <p class="text-white/60 text-sm">Loading image...</p>
            </div>
          </div>
          
          <img data-image-swiper-target="image" alt="Hole layout" class="course-image max-w-full max-h-[calc(100vh-5rem)] h-auto object-contain rounded-xl shadow-[0_4px_24px_rgba(0,0,0,0.5)]"
               src="<%= url_for(@display_image.image) %>"
               data-action="load->image-swiper#imageLoaded error->image-swiper#imageError">
          <div class="absolute bottom-3 left-1/2 -translate-x-1/2 text-xs text-white/80 bg-black/40 px-2 py-1 rounded"
               data-image-swiper-target="indexLabel"></div>
          <% if @hole.par.present? %>
            <div class="distance-marker par absolute top-[5%] left-[5%] text-2xl font-bold bg-red-500/30 border-2 border-red-500/60 text-white px-2 py-1 rounded">
            Hole <%= @hole.number %><br />
            Par <%= @hole.par %><br />
              <%= @hole.yardage %> yards
            </div>
          <% end %>
        </div>
      <% else %>
        <div class="rounded-xl border border-dashed border-white/20 p-8 text-center text-caption">
          Hole layout image not uploaded yet.
        </div>
      <% end %>
    </div>

    <aside class="sidebar w-full md:w-[380px] bg-[#141414] p-6 overflow-y-visible md:overflow-y-auto md:border-l border-white/10 snap-start min-h-[calc(100dvh-57px)] md:min-h-0" data-controller="tabs" data-tabs-active-value="<%= params[:tab].presence || 'stats' %>">
      <div class="md:hidden flex justify-center -mt-2 mb-2">
        <div class="h-1.5 w-12 rounded-full bg-white/20"></div>
      </div>
      <%= turbo_stream_from @hole_flash_stream if defined?(@hole_flash_stream) %>
      <div id="hole_flash">
        <% if notice.present? %>
          <div class="mb-3 text-sm text-[#00dc82] bg-[#00dc82]/10 border border-[#00dc82]/30 rounded px-3 py-2">
            <%= notice %>
          </div>
        <% end %>
      </div>
      <% if alert.present? %>
        <div class="mb-3 text-sm text-red-400 bg-red-500/10 border border-red-500/30 rounded px-3 py-2">
          <%= alert %>
        </div>
      <% end %>
      <div class="tabs flex gap-2 mb-6 bg-white/5 p-1 rounded-xl">
        <button class="tab flex-1 px-3 py-2 rounded-md text-sm font-medium text-white/70" data-action="click->tabs#switch" data-tabs-target="tab" data-tab="stats">Stats & Tips</button>
        <button class="tab flex-1 px-3 py-2 rounded-md text-sm font-medium text-white/70" data-action="click->tabs#switch" data-tabs-target="tab" data-tab="media">Media</button>
      </div>

      <div class="tab-panel" data-tabs-target="panel" data-tab="stats">
        <div class="mb-6">
          <h3 class="text-xs uppercase tracking-wide text-white/50 mb-3">Hole Information</h3>
          <%= form_with url: update_hole_course_path(@course, number: @hole.number), method: :patch, class: 'grid grid-cols-2 gap-3 items-end' do %>
            <input type="number" name="hole[par]" value="<%= @hole.par %>" min="3" max="5" class="stat-input w-full px-3 py-2 rounded-md bg-white/5 border border-white/10 text-white" placeholder="Par">
            <input type="number" name="hole[yardage]" value="<%= @hole.yardage %>" min="50" max="800" class="stat-input w-full px-3 py-2 rounded-md bg-white/5 border border-white/10 text-white" placeholder="Yardage">
            <div class="col-span-2">
              <button class="action-btn w-full px-3 py-2 rounded-md bg-[#00dc82] text-black font-semibold hover:bg-[#00c574]">Save Hole Stats</button>
            </div>
          <% end %>
        </div>

        <div class="mb-6">
          <h3 class="text-xs uppercase tracking-wide text-white/50 mb-3">Tees</h3>
          <div class="space-y-2">
            <% @hole.hole_tees.order(:name).each do |tee| %>
              <div class="flex items-center gap-2">
                <%= form_with url: hole_tee_course_path(@course, number: @hole.number, tee_id: tee.id), method: :patch, class: 'flex items-end gap-2' do %>
                  <input type="text" name="hole_tee[name]" value="<%= tee.name %>" class="w-28 rounded-lg bg-white/5 border border-white/10 px-3 py-2 text-white" placeholder="Name">
                  <input type="text" name="hole_tee[color]" value="<%= tee.color %>" class="w-28 rounded-lg bg-white/5 border border-white/10 px-3 py-2 text-white" placeholder="#0ea5e9">
                  <input type="number" name="hole_tee[yardage]" value="<%= tee.yardage %>" min="50" max="800" class="w-28 rounded-lg bg-white/5 border border-white/10 px-3 py-2 text-white" placeholder="Yardage">
                  <button class="px-3 py-2 rounded-md bg-white/10 text-white/80 border border-white/20">Update</button>
                <% end %>
                <%= button_to 'Remove', destroy_hole_tee_course_path(@course, number: @hole.number, tee_id: tee.id), method: :delete, class: 'px-3 py-2 rounded-md bg-red-500/10 text-red-300 border border-red-500/30' %>
              </div>
            <% end %>
          </div>
          <div class="mt-3">
            <%= form_with url: hole_tees_course_path(@course, number: @hole.number), method: :post, class: 'flex items-end gap-2' do %>
              <input type="text" name="hole_tee[name]" class="w-28 rounded-lg bg-white/5 border border-white/10 px-3 py-2 text-white" placeholder="Blue">
              <input type="text" name="hole_tee[color]" class="w-28 rounded-lg bg-white/5 border border-white/10 px-3 py-2 text-white" placeholder="#0ea5e9">
              <input type="number" name="hole_tee[yardage]" class="w-28 rounded-lg bg-white/5 border border-white/10 px-3 py-2 text-white" placeholder="Yardage">
              <button class="px-3 py-2 rounded-md bg-[#00dc82]/10 text-[#00dc82] border border-[#00dc82]/30">Add Tee</button>
            <% end %>
          </div>
        </div>

        <div class="mb-6">
          <h3 class="text-xs uppercase tracking-wide text-white/50 mb-3">Tips</h3>
          <div class="tips-list mb-4">
            <% if @hole_tips.any? %>
              <% @hole_tips.each do |tip| %>
                <div class="tip-item relative bg-white/5 border border-white/10 rounded-md p-4 mb-3" id="tip-<%= tip.id %>">
                  <div class="tip-header flex items-center justify-between mb-2">
                    <div class="flex items-center gap-2">
                      <span class="tip-type px-2 py-0.5 rounded text-xs uppercase bg-[#00dc82]/20 text-[#00dc82]">Course</span>
                      <span class="text-xs text-white/70">by <%= tip.user.display_name %></span>
                    </div>
                    <span class="tip-date text-xs text-white/50"><%= time_ago_in_words(tip.created_at) %> ago</span>
                  </div>
                  <div class="tip-content text-white/90 leading-relaxed">
                    <div class="font-medium text-white mb-1"><%= tip.title %></div>
                    <div class="text-sm"><%= tip.content %></div>
                  </div>
                  <div class="tip-actions mt-3 flex gap-2">
                    <% if current_user.saved?(tip) %>
                      <%= button_to unsave_tip_path(tip), 
                          method: :delete,
                          class: "px-3 py-1 bg-[#00dc82] text-black rounded text-xs font-medium hover:bg-[#00c574]" do %>
                        âœ“ Saved
                      <% end %>
                    <% else %>
                      <%= button_to save_tip_path(tip), 
                          method: :post,
                          class: "px-3 py-1 bg-white/10 text-white/80 rounded text-xs hover:bg-white/20" do %>
                        ðŸ’¾ Save
                      <% end %>
                    <% end %>
                    
                    <%= button_to dismiss_tip_path(tip), 
                        method: :post,
                        class: "px-3 py-1 bg-white/10 text-white/60 rounded text-xs hover:bg-red-900/30 hover:text-red-400",
                        data: { turbo_confirm: "Dismiss this tip? You won't see it again." } do %>
                      ðŸ‘Ž Dismiss
                    <% end %>
                  </div>
                </div>
              <% end %>
            <% else %>
              <p class="text-caption">No tips for this hole yet. Add one below!</p>
            <% end %>
          </div>
          <div class="add-tip-form bg-[#00dc82]/5 border border-[#00dc82]/30 rounded-md p-4 mt-4">
            <h3 class="mb-3 text-white font-medium">Add New Tip</h3>
            <%= form_with url: tips_path,
                          method: :post,
                          class: 'space-y-2',
                          data: {
                            controller: 'hole-tip-feedback',
                            action: 'turbo:submit-start->hole-tip-feedback#submitStart turbo:submit-end->hole-tip-feedback#submitEnd'
                          } do %>
              <%= hidden_field_tag 'tip[category_id]', Category.find_by(slug: 'course-tip')&.id %>
              <%= hidden_field_tag 'tip[course_id]', @course.id %>
              <%= hidden_field_tag 'tip[hole_number]', @hole.number %>
              <%= hidden_field_tag 'return_to_hole', '1' %>

              <input type="text" name="tip[title]" class="w-full px-3 py-2 bg-white/5 border border-white/10 text-white rounded" placeholder="Title (e.g., 'Play left of bunker')">
              <textarea name="tip[content]" class="w-full px-3 py-2 bg-white/5 border border-white/10 text-white rounded min-h-20" placeholder="Enter your tip or note about this hole..."></textarea>
              <button type="submit"
                      class="action-btn w-full px-3 py-2 rounded-md bg-[#00dc82] text-black font-semibold hover:bg-[#00c574]"
                      data-hole-tip-feedback-target="button">
                Add Tip
              </button>
              <p class="text-caption text-white/70 min-h-[1rem]" data-hole-tip-feedback-target="message"></p>
            <% end %>
          </div>
        </div>
      </div>

      <div class="tab-panel hidden" data-tabs-target="panel" data-tab="media">
        <%= form_with url: upload_hole_layout_course_path(@course, number: @hole.number), method: :post, html: { multipart: true, data: { controller: 'upload' } }, class: 'space-y-4' do %>
          <div class="upload-area border-2 border-dashed border-white/20 rounded-md p-8 text-center cursor-pointer hover:border-[#00dc82] hover:bg-[#00dc82]/5 transition"
               data-upload-target="zone"
               data-action="click->upload#pick dragover->upload#dragOver dragleave->upload#dragLeave drop->upload#drop">
            <div class="upload-icon text-3xl mb-2 opacity-50">ðŸ“¸</div>
            <p class="text-lg">Drop images or videos here or click to upload</p>
            <p class="text-xs opacity-60 mt-1">Supports JPG, PNG, GIF, MP4, MOV, WebM (videos 10MB)</p>
          </div>
          <input type="file" name="layout_image" accept="image/*,video/*" class="sr-only" data-upload-target="input" data-action="change->upload#changed" />
          <div class="flex gap-2">
            <button type="button" class="px-3 py-2 rounded-md bg-white/10 text-white/80 border border-white/20" data-action="upload#pick">Choose File</button>
            <button type="submit" class="px-3 py-2 rounded-md bg-[#00dc82] text-black font-semibold hover:bg-[#00c574]">Upload Layout Image</button>
          </div>

          <!-- Crop Overlay -->
          <div class="fixed inset-0 z-40 bg-black/80 hidden overflow-y-auto" data-upload-target="overlay">
            <div class="min-h-full w-full flex flex-col items-center justify-center p-4">
              <div class="w-full max-w-3xl">
                <div class="text-white/80 mb-3 flex items-center justify-between" data-upload-target="controls">
                  <div class="flex items-center gap-2">
                    <span class="text-sm">Aspect:</span>
                    <button type="button" class="px-2 py-1 rounded bg-white/10 text-white/80 border border-white/20" data-action="click->upload#setAspect" data-aspect="3:4">3:4</button>
                    <button type="button" class="px-2 py-1 rounded bg-white/10 text-white/80 border border-white/20" data-action="click->upload#setAspect" data-aspect="1:1">1:1</button>
                  </div>
                  <div class="flex items-center gap-2">
                    <span class="text-sm">Zoom</span>
                    <input type="range" min="1" max="3" step="0.01" value="1" class="w-40" data-upload-target="zoom" data-action="input->upload#zoomChanged change->upload#zoomChanged">
                  </div>
                </div>
                <div class="relative w-full max-h-[100vh] bg-black/40 rounded-lg">
                  <!-- viewport with dynamic height -->
                  <div class="w-full relative overflow-hidden bg-black/60 rounded" style="height: 0; touch-action: none;" data-upload-target="viewport">
                    <img data-upload-target="cropImage" alt="Crop preview" class="absolute top-0 left-0 select-none will-change-transform" style="user-drag: none; -webkit-user-drag: none;" />
                    <!-- mask frame for visual cue (crop boundary) -->
                    <div class="pointer-events-none absolute inset-0 border-2 border-white/50 rounded"></div>
                  </div>
                  <!-- Uploading state -->
                  <div class="absolute inset-0 hidden items-center justify-center" data-upload-target="loading">
                    <div class="flex flex-col items-center gap-3 text-white/80">
                      <svg class="animate-spin h-6 w-6 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path>
                      </svg>
                      <div class="text-sm">Uploadingâ€¦</div>
                    </div>
                  </div>
                </div>
                <div class="flex justify-end gap-2 mt-4" data-upload-target="actions">
                  <button type="button" class="px-4 py-2 rounded-md bg-white/10 text-white/80 border border-white/20" data-action="upload#cancelCrop">Cancel</button>
                  <button type="button" class="px-4 py-2 rounded-md bg-[#00dc82] text-black font-semibold hover:bg-[#00c574]" data-action="upload#confirmCrop">Use Crop</button>
                </div>
              </div>
            </div>
          </div>
        <% end %>
        <div class="mt-6">
          <h3 class="mb-3 text-xs uppercase tracking-wide text-white/50">Saved Media</h3>
          <%= turbo_stream_from @hole_image_stream if defined?(@hole_image_stream) %>
          <div id="hole_images_grid" class="grid grid-cols-2 gap-2">
            <% if @recent_hole_images.any? %>
              <% @recent_hole_images.each do |img| %>
                <%= render partial: 'hole_images/tile', locals: { image: img, course: @course, hole: @hole } %>
              <% end %>
            <% else %>
              <div class="aspect-square bg-white/5 rounded flex items-center justify-center text-white/30">No media yet</div>
            <% end %>
          </div>
        </div>
      </div>
    </aside>
  </div>

  <% prev = @hole.number - 1 %>
  <% nextn = @hole.number + 1 %>
  <footer class="fixed inset-x-0 bottom-0 z-10 bg-gradient-to-t from-black/100 to-transparent pt-2 pb-[calc(0.5rem+env(safe-area-inset-bottom))] px-4">
    <div class="max-w-[1600px] mx-auto flex items-center justify-between gap-3">
      <div class="w-1/2 pr-2 text-white font-medium truncate hover:overflow-x-auto focus:overflow-x-auto" title="<%= @course.name %> â€” Hole <%= @hole.number %>">
        <span class="inline-block align-middle"><%= @course.name %> â€” Hole <%= @hole.number %></span>
      </div>
      <div class="flex items-center gap-2 shrink-0">
        <%= link_to 'Prev', (prev >= 1 ? hole_course_path(@course, number: prev) : '#'), class: "px-4 py-2 rounded-md border border-white/20 text-white/90 bg-white/10 hover:bg-white/15 #{'pointer-events-none opacity-50' if prev < 1}" %>
        <%= link_to 'All Holes', course_path(@course), class: 'px-4 py-2 rounded-md border border-white/20 text-white/90 bg-white/10 hover:bg-white/15' %>
        <%= link_to 'Next', (nextn <= @max_hole_number ? hole_course_path(@course, number: nextn) : '#'), class: "px-4 py-2 rounded-md bg-[#00dc82] text-black font-semibold hover:bg-[#00c574] #{'pointer-events-none opacity-50' if nextn > @max_hole_number}" %>
      </div>
    </div>
  </footer>
</div>

